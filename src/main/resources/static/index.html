<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动态表管理</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #bd2130;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden {
            display: none;
        }
        .actions {
            display: flex;
            gap: 5px;
        }
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal.show {
            display: block;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        .modal-actions {
            margin-top: 20px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>动态表管理系统</h1>
        
        <!-- 步骤1：创建表 -->
        <div class="container" v-if="!tableName">
            <h2>第一步：创建新表</h2>
            <div class="form-group">
                <label for="tableNameInput">表名（留空则自动生成）：</label>
                <input type="text" id="tableNameInput" v-model="inputTableName" placeholder="例如：users_table">
            </div>
            <div class="form-group">
                <label for="sampleData">示例行数据（JSON格式）：</label>
                <textarea id="sampleData" v-model="sampleData" rows="6" placeholder='{"name": "张三", "age": 25, "email": "zhangsan@example.com"}'></textarea>
            </div>
            <button @click="createTable">创建表</button>
        </div>

        <!-- 步骤2：管理表数据 -->
        <div class="container" v-else>
            <h2>表：{{ tableName }}</h2>
            <button @click="showAddModal" class="primary">添加记录</button>
            <button @click="dropTable" class="danger">删除表</button>
            <button @click="refreshData">刷新数据</button>
            
            <!-- 显示数据 -->
            <div class="container">
                <h3>表数据</h3>
                <div v-if="message" :class="['alert', message.type === 'success' ? 'alert-success' : 'alert-error']">
                    {{ message.text }}
                </div>
                
                <table v-if="tableData.length > 0">
                    <thead>
                        <tr>
                            <th v-for="column in columns" :key="column">{{ column }}</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(row, index) in tableData" :key="index">
                            <td v-for="column in columns" :key="column">
                                {{ row[column] }}
                            </td>
                            <td>
                                <div class="actions">
                                    <button @click="showEditModal(index, row)">编辑</button>
                                    <button @click="deleteRow(index, row.id)" class="danger">删除</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <p v-else>暂无数据</p>
            </div>
        </div>
        
        <!-- 添加记录模态框 -->
        <div :class="['modal', { show: showAddModalFlag }]" id="addModal">
            <div class="modal-content">
                <span class="close" @click="closeAddModal">&times;</span>
                <h3>添加新记录</h3>
                <div v-for="(value, key) in newData" :key="key" class="form-group">
                    <label :for="'new_' + key">{{ key }}:</label>
                    <input :id="'new_' + key" v-model="newData[key]" type="text">
                </div>
                <div class="modal-actions">
                    <button @click="closeAddModal">取消</button>
                    <button @click="addRecord">添加记录</button>
                </div>
            </div>
        </div>
        
        <!-- 编辑记录模态框 -->
        <div :class="['modal', { show: showEditModalFlag }]" id="editModal">
            <div class="modal-content">
                <span class="close" @click="closeEditModal">&times;</span>
                <h3>编辑记录</h3>
                <div v-for="(value, key) in editingData" :key="key" class="form-group">
                    <label :for="'edit_' + key">{{ key }}:</label>
                    <input :id="'edit_' + key" v-model="editingData[key]" type="text">
                </div>
                <div class="modal-actions">
                    <button @click="closeEditModal">取消</button>
                    <button @click="saveEdit">保存记录</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;
        
        createApp({
            setup() {
                // 表相关状态
                const tableName = ref(localStorage.getItem('dynamic_table_name') || '');
                const inputTableName = ref('');
                const sampleData = ref('{\n  "name": "张三",\n  "age": 25,\n  "email": "zhangsan@example.com"\n}');
                
                // 数据相关状态
                const tableData = ref([]);
                const columns = ref([]);
                const newData = reactive({});
                const message = ref(null);
                
                // 模态框状态
                const showAddModalFlag = ref(false);
                const showEditModalFlag = ref(false);
                
                // 编辑相关状态
                const editingIndex = ref(-1);
                const editingData = reactive({});
                
                // 显示添加模态框
                const showAddModal = () => {
                    showAddModalFlag.value = true;
                };
                
                // 关闭添加模态框
                const closeAddModal = () => {
                    showAddModalFlag.value = false;
                };
                
                // 显示编辑模态框
                const showEditModal = (index, rowData) => {
                    editingIndex.value = index;
                    // 深拷贝 rowData 到 editingData
                    Object.keys(rowData).forEach(key => {
                        editingData[key] = rowData[key];
                    });
                    showEditModalFlag.value = true;
                };
                
                // 关闭编辑模态框
                const closeEditModal = () => {
                    showEditModalFlag.value = false;
                    editingIndex.value = -1;
                    // 清空 editingData
                    Object.keys(editingData).forEach(key => {
                        delete editingData[key];
                    });
                };
                
                // 创建表
                const createTable = async () => {
                    try {
                        let actualTableName = inputTableName.value;
                        // 如果没有提供表名，则生成一个随机表名
                        if (!actualTableName) {
                            actualTableName = 'table_' + Math.random().toString(36).substring(2, 10);
                        }
                        
                        const sampleDataRow = JSON.parse(sampleData.value);
                        
                        const response = await fetch(`/api/fully-dynamic/${actualTableName}/create-table`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(sampleDataRow)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            tableName.value = actualTableName;
                            localStorage.setItem('dynamic_table_name', actualTableName);
                            
                            // 初始化新数据对象
                            Object.keys(sampleDataRow).forEach(key => {
                                if (key !== 'id') {
                                    newData[key] = '';
                                }
                            });
                            
                            showMessage('表创建成功', 'success');
                            await loadData();
                        } else {
                            showMessage('表创建失败: ' + result.message, 'error');
                        }
                    } catch (error) {
                        showMessage('发生错误: ' + error.message, 'error');
                    }
                };
                
                // 删除表
                const dropTable = async () => {
                    if (!confirm(`确定要删除表 "${tableName.value}" 吗？此操作不可恢复。`)) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/fully-dynamic/${tableName.value}/drop-table`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // 清除本地状态
                            tableName.value = '';
                            inputTableName.value = '';
                            localStorage.removeItem('dynamic_table_name');
                            tableData.value = [];
                            columns.value = [];
                            Object.keys(newData).forEach(key => {
                                delete newData[key];
                            });
                            
                            showMessage('表删除成功', 'success');
                        } else {
                            showMessage('表删除失败: ' + result.message, 'error');
                        }
                    } catch (error) {
                        showMessage('发生错误: ' + error.message, 'error');
                    }
                };
                
                // 加载数据
                const loadData = async () => {
                    try {
                        const response = await fetch(`/api/fully-dynamic/${tableName.value}`);
                        const result = await response.json();
                        
                        if (result.success) {
                            // 提取列名
                            if (result.data.length > 0) {
                                // 从第一行数据推断列名
                                const firstRow = result.data[0];
                                columns.value = Object.keys(firstRow);
                                
                                // 如果newData为空，初始化它（解决刷新页面后输入框消失的问题）
                                if (Object.keys(newData).length === 0) {
                                    columns.value.forEach(col => {
                                        if (col !== 'id') {
                                            newData[col] = '';
                                        }
                                    });
                                }
                            }
                            
                            // 处理数据，将数组转换为对象
                            tableData.value = result.data.map(rowArray => {
                                const rowObj = {};
                                columns.value.forEach((col, index) => {
                                    rowObj[col] = rowArray[index];
                                });
                                return rowObj;
                            });
                        } else {
                            showMessage('数据加载失败: ' + result.message, 'error');
                        }
                    } catch (error) {
                        showMessage('数据加载出错: ' + error.message, 'error');
                    }
                };
                
                // 刷新数据
                const refreshData = () => {
                    loadData();
                };
                
                // 添加记录
                const addRecord = async () => {
                    try {
                        const response = await fetch(`/api/fully-dynamic/${tableName.value}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(newData)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showMessage('记录添加成功', 'success');
                            // 清空输入框
                            Object.keys(newData).forEach(key => {
                                if (key !== 'id') {
                                    newData[key] = '';
                                }
                            });
                            closeAddModal();
                            await loadData();
                        } else {
                            showMessage('记录添加失败: ' + result.message, 'error');
                        }
                    } catch (error) {
                        showMessage('发生错误: ' + error.message, 'error');
                    }
                };
                
                // 保存编辑
                const saveEdit = async () => {
                    try {
                        const id = editingData.id;
                        const dataToSend = { ...editingData };
                        delete dataToSend.id; // 移除id字段，避免更新时出现问题
                        
                        const response = await fetch(`/api/fully-dynamic/${tableName.value}?id=${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(dataToSend)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showMessage('记录更新成功', 'success');
                            closeEditModal();
                            await loadData();
                        } else {
                            showMessage('记录更新失败: ' + result.message, 'error');
                        }
                    } catch (error) {
                        showMessage('发生错误: ' + error.message, 'error');
                    }
                };
                
                // 删除行
                const deleteRow = async (index, id) => {
                    if (!confirm('确定要删除这条记录吗？')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/fully-dynamic/${tableName.value}?id=${id}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showMessage('记录删除成功', 'success');
                            await loadData();
                        } else {
                            showMessage('记录删除失败: ' + result.message, 'error');
                        }
                    } catch (error) {
                        showMessage('发生错误: ' + error.message, 'error');
                    }
                };
                
                // 显示消息
                const showMessage = (text, type) => {
                    message.value = { text, type };
                    setTimeout(() => {
                        message.value = null;
                    }, 3000);
                };
                
                // 在组件挂载时加载数据
                onMounted(async () => {
                    if (tableName.value) {
                        // 如果表名存在，获取表的列信息和数据
                        await getTableColumns();
                        await loadData();
                    }
                });
                
                // 获取表的列信息
                const getTableColumns = async () => {
                    try {
                        const response = await fetch(`/api/fully-dynamic/${tableName.value}/columns`, {
                            method: 'GET'
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // 从返回的结果中提取列名
                            // DESCRIBE命令返回的结果包含列名、类型、是否为空等信息
                            // 我们只需要列名，它是结果数组中每个子数组的第一个元素
                            columns.value = result.data.map(columnInfo => columnInfo[0]);
                            
                            // 初始化newData对象
                            columns.value.forEach(col => {
                                if (col !== 'id') {
                                    newData[col] = '';
                                }
                            });
                        }
                    } catch (error) {
                        console.error('获取表列信息失败:', error);
                        showMessage('获取表列信息失败: ' + error.message, 'error');
                    }
                };

                return {
                    tableName,
                    inputTableName,
                    sampleData,
                    tableData,
                    columns,
                    newData,
                    message,
                    showAddModalFlag,
                    showEditModalFlag,
                    editingIndex,
                    editingData,
                    createTable,
                    dropTable,
                    refreshData,
                    addRecord,
                    saveEdit,
                    deleteRow,
                    showAddModal,
                    closeAddModal,
                    showEditModal,
                    closeEditModal,
                    getTableColumns
                };
            }
        }).mount('#app');
    </script>
</body>
</html>